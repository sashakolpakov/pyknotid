

<!DOCTYPE html>
<html class="writer-html5" lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>pyknotid.spacecurves.periodiccell &mdash; pyknotid 0.5.4 documentation</title>
      <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css?v=03e43079" />
      <link rel="stylesheet" type="text/css" href="../../../_static/css/theme.css?v=e59714d7" />

  
      <script src="../../../_static/jquery.js?v=5d32c60e"></script>
      <script src="../../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script data-url_root="../../../" id="documentation_options" src="../../../_static/documentation_options.js?v=c3dca1ed"></script>
      <script src="../../../_static/doctools.js?v=888ff710"></script>
      <script src="../../../_static/sphinx_highlight.js?v=4825356b"></script>
    <script src="../../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../../index.html" class="icon icon-home">
            pyknotid
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../../../sources/overview.html">Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../sources/spacecurves/index.html">Space curve analysis</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../sources/invariants.html">Invariants</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../sources/invariants.html#pyknotid.invariants.alexander"><code class="docutils literal notranslate"><span class="pre">alexander()</span></code></a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../sources/invariants.html#pyknotid.invariants.alexander_cypari"><code class="docutils literal notranslate"><span class="pre">alexander_cypari()</span></code></a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../sources/invariants.html#pyknotid.invariants.alexander_mathematica"><code class="docutils literal notranslate"><span class="pre">alexander_mathematica()</span></code></a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../sources/invariants.html#pyknotid.invariants.alexander_maxima"><code class="docutils literal notranslate"><span class="pre">alexander_maxima()</span></code></a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../sources/invariants.html#pyknotid.invariants.arnold_2St_2Jminus"><code class="docutils literal notranslate"><span class="pre">arnold_2St_2Jminus()</span></code></a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../sources/invariants.html#pyknotid.invariants.arnold_2St_2Jplus"><code class="docutils literal notranslate"><span class="pre">arnold_2St_2Jplus()</span></code></a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../sources/invariants.html#pyknotid.invariants.contract_points"><code class="docutils literal notranslate"><span class="pre">contract_points()</span></code></a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../sources/invariants.html#pyknotid.invariants.hyperbolic_volume"><code class="docutils literal notranslate"><span class="pre">hyperbolic_volume()</span></code></a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../sources/invariants.html#pyknotid.invariants.jones_mathematica"><code class="docutils literal notranslate"><span class="pre">jones_mathematica()</span></code></a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../sources/invariants.html#pyknotid.invariants.second_order_writhe"><code class="docutils literal notranslate"><span class="pre">second_order_writhe()</span></code></a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../sources/invariants.html#pyknotid.invariants.self_linking"><code class="docutils literal notranslate"><span class="pre">self_linking()</span></code></a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../sources/invariants.html#pyknotid.invariants.vassiliev_degree_2"><code class="docutils literal notranslate"><span class="pre">vassiliev_degree_2()</span></code></a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../sources/invariants.html#pyknotid.invariants.vassiliev_degree_3"><code class="docutils literal notranslate"><span class="pre">vassiliev_degree_3()</span></code></a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../sources/invariants.html#pyknotid.invariants.virtual_vassiliev_degree_3"><code class="docutils literal notranslate"><span class="pre">virtual_vassiliev_degree_3()</span></code></a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../sources/representations/index.html">Topological representations</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../sources/catalogue/index.html">Knot catalogue</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../sources/visualise.html">Visualise</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../sources/visualise.html#pyknotid.visualise.plot_line"><code class="docutils literal notranslate"><span class="pre">plot_line()</span></code></a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../sources/visualise.html#pyknotid.visualise.plot_projection"><code class="docutils literal notranslate"><span class="pre">plot_projection()</span></code></a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../sources/visualise.html#pyknotid.visualise.plot_shell_vispy"><code class="docutils literal notranslate"><span class="pre">plot_shell_vispy()</span></code></a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../sources/visualise.html#pyknotid.visualise.plot_sphere_lambert_sharp_vispy"><code class="docutils literal notranslate"><span class="pre">plot_sphere_lambert_sharp_vispy()</span></code></a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../sources/visualise.html#pyknotid.visualise.plot_sphere_lambert_vispy"><code class="docutils literal notranslate"><span class="pre">plot_sphere_lambert_vispy()</span></code></a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../sources/visualise.html#pyknotid.visualise.plot_sphere_mollweide_vispy"><code class="docutils literal notranslate"><span class="pre">plot_sphere_mollweide_vispy()</span></code></a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../sources/visualise.html#pyknotid.visualise.plot_sphere_shell_vispy"><code class="docutils literal notranslate"><span class="pre">plot_sphere_shell_vispy()</span></code></a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../sources/about.html">About pyknotid</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">pyknotid</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../../index.html">Module code</a></li>
      <li class="breadcrumb-item active">pyknotid.spacecurves.periodiccell</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for pyknotid.spacecurves.periodiccell</h1><div class="highlight"><pre>
<span></span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">PeriodicCell</span>
<span class="sd">------------</span>

<span class="sd">Tools for working with a periodic cell of spacecurves.</span>

<span class="sd">API documentation</span>
<span class="sd">~~~~~~~~~~~~~~~~~</span>
<span class="sd">&#39;&#39;&#39;</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pyknotid.utils</span><span class="w"> </span><span class="kn">import</span> <span class="n">ensure_shape_tuple</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pyknotid.spacecurves</span><span class="w"> </span><span class="kn">import</span> <span class="n">Knot</span><span class="p">,</span> <span class="n">OpenKnot</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>

<div class="viewcode-block" id="Cell"><a class="viewcode-back" href="../../../sources/spacecurves/periodiccell.html#pyknotid.spacecurves.periodiccell.Cell">[docs]</a><span class="k">class</span><span class="w"> </span><span class="nc">Cell</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;Class for holding the vertices of some number of lines with</span>
<span class="sd">    periodic boundary conditions.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ==========</span>
<span class="sd">    lines : list</span>
<span class="sd">        Must be a list of Knots or ndarrays of vertices.</span>
<span class="sd">    shape : tuble or int</span>
<span class="sd">        The shape of the cell, in whatever units the lines use.</span>
<span class="sd">    periodic : bool</span>
<span class="sd">        Whether the cell is periodic. If True, lines are marked as</span>
<span class="sd">        &#39;nth&#39; or &#39;loop&#39; in self.line_types. Defaults to True.</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lines</span><span class="p">,</span> <span class="n">shape</span><span class="p">,</span> <span class="n">periodic</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">cram</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">downsample</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">shape</span> <span class="o">=</span> <span class="n">ensure_shape_tuple</span><span class="p">(</span><span class="n">shape</span><span class="p">)</span>

        <span class="n">lines</span> <span class="o">=</span> <span class="p">[</span><span class="n">l</span> <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">lines</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">l</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">downsample</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">lines</span> <span class="o">=</span> <span class="p">[</span><span class="n">l</span><span class="p">[::</span><span class="n">downsample</span><span class="p">]</span> <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">]</span>
        <span class="n">lines</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="n">_interpret_line</span><span class="p">,</span> <span class="n">lines</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">cram</span><span class="p">:</span>
            <span class="n">lines</span> <span class="o">=</span> <span class="p">[</span><span class="n">_cram_into_cell</span><span class="p">(</span><span class="n">l</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lines</span> <span class="o">=</span> <span class="p">[</span><span class="n">_cut_line_at_jumps</span><span class="p">(</span><span class="n">l</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">periodic</span> <span class="o">=</span> <span class="n">periodic</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">line_types</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">periodic</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">line_types</span> <span class="o">=</span> <span class="p">[</span><span class="n">_test_periodicity</span><span class="p">(</span><span class="n">l</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">lines</span><span class="p">]</span>

<div class="viewcode-block" id="Cell.from_qwer"><a class="viewcode-back" href="../../../sources/spacecurves/periodiccell.html#pyknotid.spacecurves.periodiccell.Cell.from_qwer">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">from_qwer</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">qwer</span><span class="p">,</span> <span class="n">shape</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;Returns an instance of Cell from a quartet of differently</span>
<span class="sd">        classified lines in periodic boundaries.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        qwer : tuple</span>
<span class="sd">            Should be a 4-tuple of lists q, w, e, r. q is closed</span>
<span class="sd">            loops, w is lines with non-trivial homology, e is lines that</span>
<span class="sd">            terminate on the boundaries of the cell, r is any remaining</span>
<span class="sd">            (unclassified) lines.</span>
<span class="sd">        shape : int or tuple</span>
<span class="sd">            The size of the cell along each axis. If a single number</span>
<span class="sd">            is passed, all axes are assumed to be the same length.</span>

<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">q</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">e</span><span class="p">,</span> <span class="n">r</span> <span class="o">=</span> <span class="n">qwer</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">w</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">w</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nb">tuple</span><span class="p">):</span>
            <span class="n">w</span> <span class="o">=</span> <span class="p">[</span><span class="n">l</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">w</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">e</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">e</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nb">tuple</span><span class="p">):</span>
            <span class="n">e</span> <span class="o">=</span> <span class="p">[</span><span class="n">l</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">e</span><span class="p">]</span>
        <span class="n">output</span> <span class="o">=</span> <span class="bp">cls</span><span class="p">(</span><span class="n">q</span><span class="o">+</span><span class="n">w</span><span class="o">+</span><span class="n">e</span><span class="p">,</span> <span class="n">shape</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="n">output</span><span class="o">.</span><span class="n">qwer</span> <span class="o">=</span> <span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">e</span><span class="p">,</span> <span class="n">r</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">output</span></div>

    <span class="k">def</span><span class="w"> </span><span class="nf">append</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">line</span><span class="p">,</span> <span class="n">cram</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="n">line</span> <span class="o">=</span> <span class="n">_interpret_line</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">cram</span><span class="p">:</span>
            <span class="n">line</span> <span class="o">=</span> <span class="n">_cram_into_cell</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">plot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">boundary</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">clf</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">tube_radius</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span>
             <span class="n">length_colours</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
             <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="kn">from</span><span class="w"> </span><span class="nn">pyknotid.visualise</span><span class="w"> </span><span class="kn">import</span> <span class="n">plot_cell</span>
        <span class="n">boundary</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">shape</span> <span class="k">if</span> <span class="n">boundary</span> <span class="k">else</span> <span class="kc">None</span>

        <span class="k">if</span> <span class="n">length_colours</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="s1">&#39;colours&#39;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="s1">&#39;colours and length_colours cannot both be set&#39;</span><span class="p">)</span>

            <span class="n">q</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">e</span><span class="p">,</span> <span class="n">r</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">qwer</span>
            <span class="kn">from</span><span class="w"> </span><span class="nn">pyknotid.spacecurves.openknot</span><span class="w"> </span><span class="kn">import</span> <span class="n">OpenKnot</span>

            <span class="n">lengths</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">q</span> <span class="o">+</span> <span class="n">w</span> <span class="o">+</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">k</span> <span class="o">=</span> <span class="n">OpenKnot</span><span class="o">.</span><span class="n">from_periodic_line</span><span class="p">(</span><span class="n">line</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
                <span class="n">length</span> <span class="o">=</span> <span class="n">k</span><span class="o">.</span><span class="n">arclength</span><span class="p">()</span>
                <span class="n">lengths</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">length</span><span class="p">)</span>
            <span class="n">total_length</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">lengths</span><span class="p">)</span>
            <span class="n">lengths</span> <span class="o">=</span> <span class="p">[</span><span class="n">l</span> <span class="o">/</span> <span class="n">total_length</span> <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">lengths</span><span class="p">]</span>

            <span class="n">colours</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">length</span> <span class="ow">in</span> <span class="n">lengths</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">bound</span><span class="p">,</span> <span class="n">colour</span> <span class="ow">in</span> <span class="n">length_colours</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>
                    <span class="k">if</span> <span class="n">length</span> <span class="o">&lt;</span> <span class="n">bound</span><span class="p">:</span>
                        <span class="n">colours</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">colour</span><span class="p">)</span>
                        <span class="k">break</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">colours</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">length_colours</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
            <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;colours&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">colours</span>

        <span class="n">plot_cell</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lines</span><span class="p">,</span> <span class="n">boundary</span><span class="o">=</span><span class="n">boundary</span><span class="p">,</span> <span class="n">clf</span><span class="o">=</span><span class="n">clf</span><span class="p">,</span>
                  <span class="n">tube_radius</span><span class="o">=</span><span class="n">tube_radius</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

<div class="viewcode-block" id="Cell.smooth"><a class="viewcode-back" href="../../../sources/spacecurves/periodiccell.html#pyknotid.spacecurves.periodiccell.Cell.smooth">[docs]</a>    <span class="k">def</span><span class="w"> </span><span class="nf">smooth</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">repeats</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">window_len</span><span class="o">=</span><span class="mi">10</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;Smooth each line in the curve, equivalent to</span>
<span class="sd">        :meth:`~pyknotid.spacecurves.spacecurve.SpaceCurve.smooth`.</span>

<span class="sd">        &#39;&#39;&#39;</span>
        <span class="kn">from</span><span class="w"> </span><span class="nn">pyknotid.spacecurves</span><span class="w"> </span><span class="kn">import</span> <span class="n">Knot</span>
        <span class="n">new_lines</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">line</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lines</span><span class="p">):</span>
            <span class="n">new_segments</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">segment</span> <span class="ow">in</span> <span class="n">line</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">segment</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">window_len</span><span class="p">:</span>
                    <span class="n">k</span> <span class="o">=</span> <span class="n">Knot</span><span class="p">(</span><span class="n">segment</span><span class="p">)</span>
                    <span class="n">k</span><span class="o">.</span><span class="n">smooth</span><span class="p">(</span><span class="n">repeats</span><span class="p">,</span> <span class="n">periodic</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">window_len</span><span class="o">=</span><span class="n">window_len</span><span class="p">)</span>
                    <span class="n">new_segments</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">k</span><span class="o">.</span><span class="n">points</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">new_segments</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">segment</span><span class="p">)</span>
            <span class="n">new_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">new_segments</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lines</span> <span class="o">=</span> <span class="n">new_lines</span></div>

    <span class="k">def</span><span class="w"> </span><span class="nf">to_povray</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filen</span><span class="p">,</span> <span class="n">spline</span><span class="o">=</span><span class="s1">&#39;cubic_spline&#39;</span><span class="p">):</span>
        <span class="kn">from</span><span class="w"> </span><span class="nn">pyknotid.visualise</span><span class="w"> </span><span class="kn">import</span> <span class="n">cell_to_povray</span>
        <span class="n">cell_to_povray</span><span class="p">(</span><span class="n">filen</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">lines</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">get_lengths</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="kn">from</span><span class="w"> </span><span class="nn">pyknotid.spacecurves.openknot</span><span class="w"> </span><span class="kn">import</span> <span class="n">OpenKnot</span>
        <span class="n">lengths</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">lines</span><span class="p">:</span>
            <span class="n">points</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
            <span class="n">k</span> <span class="o">=</span> <span class="n">OpenKnot</span><span class="o">.</span><span class="n">from_periodic_line</span><span class="p">(</span><span class="n">points</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span>
                                            <span class="n">perturb</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="n">lengths</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">k</span><span class="o">.</span><span class="n">arclength</span><span class="p">())</span>
        <span class="k">return</span> <span class="n">lengths</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">simplify</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">num</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">cut_selection</span><span class="o">=</span><span class="s1">&#39;uniform&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="kn">from</span><span class="w"> </span><span class="nn">pyknotid.simplify</span><span class="w"> </span><span class="kn">import</span> <span class="n">octree</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num</span><span class="p">):</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;i = </span><span class="si">{}</span><span class="s1"> / </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">num</span><span class="p">))</span>
            <span class="n">ot</span> <span class="o">=</span> <span class="n">octree</span><span class="o">.</span><span class="n">OctreeCell</span><span class="o">.</span><span class="n">from_cell_lines</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lines</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span>
                                                <span class="n">cut_selection</span><span class="o">=</span><span class="n">cut_selection</span><span class="p">,</span>
                                                <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="n">ot</span><span class="o">.</span><span class="n">simplify</span><span class="p">()</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">lines</span> <span class="o">=</span> <span class="p">[</span><span class="n">_cut_line_at_jumps</span><span class="p">(</span><span class="n">l</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span>
                        <span class="n">ot</span><span class="o">.</span><span class="n">get_lines</span><span class="p">()]</span>

<div class="viewcode-block" id="Cell.linking_matrix"><a class="viewcode-back" href="../../../sources/spacecurves/periodiccell.html#pyknotid.spacecurves.periodiccell.Cell.linking_matrix">[docs]</a>    <span class="k">def</span><span class="w"> </span><span class="nf">linking_matrix</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;Get the linking numbers of each line in the cell with every</span>
<span class="sd">        other.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="kn">from</span><span class="w"> </span><span class="nn">pyknotid.spacecurves.openknot</span><span class="w"> </span><span class="kn">import</span> <span class="n">OpenKnot</span>
        <span class="kn">from</span><span class="w"> </span><span class="nn">pyknotid.spacecurves.link</span><span class="w"> </span><span class="kn">import</span> <span class="n">Link</span>
        <span class="kn">from</span><span class="w"> </span><span class="nn">collections</span><span class="w"> </span><span class="kn">import</span> <span class="n">defaultdict</span>

        <span class="n">lines</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lines</span>
        
        <span class="n">types</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;loop&#39;</span> <span class="k">if</span> <span class="n">_is_closed_loop</span><span class="p">(</span>
            <span class="n">OpenKnot</span><span class="o">.</span><span class="n">from_periodic_line</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">(</span><span class="n">l</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span>
                                        <span class="n">perturb</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">points</span><span class="p">)</span>
                 <span class="k">else</span> <span class="s1">&#39;line&#39;</span> <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">]</span>

        <span class="n">linkings</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">lines</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">lines</span><span class="p">)))</span>

        <span class="n">linkings</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="k">for</span> <span class="n">i1</span><span class="p">,</span> <span class="n">details</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">lines</span><span class="p">,</span> <span class="n">types</span><span class="p">)):</span>
            <span class="n">line1</span><span class="p">,</span> <span class="n">line_type1</span> <span class="o">=</span> <span class="n">details</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;i1 is&#39;</span><span class="p">,</span> <span class="n">i1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">lines</span><span class="p">))</span>
            <span class="k">for</span> <span class="n">i2</span><span class="p">,</span> <span class="n">other_details</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">lines</span><span class="p">[</span><span class="n">i1</span><span class="p">:],</span> <span class="n">types</span><span class="p">[</span><span class="n">i1</span><span class="p">:])):</span>
                <span class="n">i2</span> <span class="o">+=</span> <span class="n">i1</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;i2 is&#39;</span><span class="p">,</span> <span class="n">i2</span><span class="p">)</span>
                <span class="n">line2</span><span class="p">,</span> <span class="n">line_type2</span> <span class="o">=</span> <span class="n">other_details</span>

                <span class="k">if</span> <span class="n">line_type1</span> <span class="o">==</span> <span class="s1">&#39;loop&#39;</span> <span class="ow">and</span> <span class="n">line_type2</span> <span class="o">==</span> <span class="s1">&#39;loop&#39;</span><span class="p">:</span>

                    <span class="n">linking</span> <span class="o">=</span> <span class="n">get_linking_between_loops</span><span class="p">(</span>
                        <span class="n">line1</span><span class="p">,</span> <span class="n">line2</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">same_loop</span><span class="o">=</span><span class="p">(</span><span class="n">i1</span><span class="o">==</span><span class="n">i2</span><span class="p">))</span>
                    
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;linking is&#39;</span><span class="p">,</span> <span class="n">linking</span><span class="p">)</span>

                    <span class="k">if</span> <span class="n">linking</span><span class="p">:</span>
                        <span class="n">linkings</span><span class="p">[(</span><span class="n">i1</span><span class="p">,</span> <span class="n">i2</span><span class="p">)]</span> <span class="o">=</span> <span class="n">linking</span>

                <span class="k">elif</span> <span class="n">line_type1</span> <span class="o">==</span> <span class="s1">&#39;loop&#39;</span> <span class="ow">and</span> <span class="n">line_type2</span> <span class="o">==</span> <span class="s1">&#39;line&#39;</span><span class="p">:</span>
                    <span class="n">linking</span> <span class="o">=</span> <span class="n">get_linking_between_loop_and_line</span><span class="p">(</span>
                        <span class="n">line1</span><span class="p">,</span> <span class="n">line2</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>

                <span class="c1"># Same as previous condition, just the opposite order</span>
                <span class="k">elif</span> <span class="n">line_type1</span> <span class="o">==</span> <span class="s1">&#39;line&#39;</span> <span class="ow">and</span> <span class="n">line_type2</span> <span class="o">==</span> <span class="s1">&#39;loop&#39;</span><span class="p">:</span>
                    <span class="n">linking</span> <span class="o">=</span> <span class="n">get_linking_between_loop_and_line</span><span class="p">(</span>
                        <span class="n">line2</span><span class="p">,</span> <span class="n">line1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>

                <span class="k">elif</span> <span class="n">line_type1</span> <span class="o">==</span> <span class="s1">&#39;line&#39;</span> <span class="ow">and</span> <span class="n">line_type2</span> <span class="o">==</span> <span class="s1">&#39;line&#39;</span><span class="p">:</span>
                    <span class="k">pass</span>

        <span class="k">return</span> <span class="n">linkings</span></div></div>
        

    <span class="c1"># def efficient_linking_matrix(self):</span>
    <span class="c1">#     &#39;&#39;&#39;Get the linking numbers of each line in the cell with every</span>
    <span class="c1">#     other.</span>
    <span class="c1">#     &#39;&#39;&#39;</span>
    <span class="c1">#     # Should this be the periodic linking number or not?</span>

    <span class="c1">#     linkings = np.zeros((len(self.lines),</span>
    <span class="c1">#                          len(self.lines)))</span>

    <span class="c1">#     import chelpers</span>

    <span class="c1">#     all_crossings = []</span>

    <span class="c1">#     for i1, line in enumerate(self.lines):</span>
    <span class="c1">#         segments_1 = line</span>

    <span class="c1">#         cum_lengths_1 = np.cumsum(map(len, segments_1))</span>
    <span class="c1">#         print(&#39;i1 is&#39;, i1, len(self.lines))</span>

    <span class="c1">#         for i2, other_line in enumerate(self.lines[i1+1:]):</span>
    <span class="c1">#             i2 += 1</span>
    <span class="c1">#             segments_2 = line</span>
    <span class="c1">#             cum_lengths_2 = np.cumsum(map(len, segments_2))</span>

    <span class="c1">#             steps_2 = [</span>
    <span class="c1">#                 np.roll(segment[:, :2], -1, axis=0) - segment[:, :2] for</span>
    <span class="c1">#                 segment in segments_1]</span>
    <span class="c1">#             step_lengths_2 = []</span>
    <span class="c1">#             for steps in steps_2:</span>
    <span class="c1">#                 step_lengths_2.append(np.array(</span>
    <span class="c1">#                     [np.sqrt(np.sum(row**2))</span>
    <span class="c1">#                      for row in steps]))</span>
    <span class="c1">#             max_step_lengths_2 = [np.max(ls) for ls in</span>
    <span class="c1">#                                       step_lengths_2]</span>

    <span class="c1">#             current_linking = 0</span>
    <span class="c1">#             current_offset = (0, 0, 0)</span>

    <span class="c1">#             crossings = []</span>

    <span class="c1">#             for segment_1, current_index in zip(segments_1, cum_lengths_1):</span>
    <span class="c1">#                 for i, point in enumerate(segment_1[:-1]):</span>
    <span class="c1">#                     next_point = segment_1[i+1]</span>
    <span class="c1">#                     crossing_index = current_index + i</span>
    <span class="c1">#                     dv = next_point - point</span>
    <span class="c1">#                     for crossing_index_2, segment_2, lengths_2, max_step_length in zip(</span>
    <span class="c1">#                             cum_lengths_2, segments_2,</span>
    <span class="c1">#                             step_lengths_2,</span>
    <span class="c1">#                             max_step_lengths_2):</span>

    <span class="c1">#                         new_crossings = chelpers.find_crossings(</span>
    <span class="c1">#                             point, dv,</span>
    <span class="c1">#                             segment_2,</span>
    <span class="c1">#                             lengths_2,</span>
    <span class="c1">#                             crossing_index,</span>
    <span class="c1">#                             0,</span>
    <span class="c1">#                             max_step_length</span>
    <span class="c1">#                             )</span>
    <span class="c1">#                         if new_crossings:</span>
    <span class="c1">#                             new_crossings = np.array(new_crossings)</span>
    <span class="c1">#                             new_crossings[::2, 1] += crossing_index_2</span>
    <span class="c1">#                             new_crossings[1::2, 0] += crossing_index_2</span>
    <span class="c1">#                             # new_crossings[:, 1] += crossing_index_2</span>
    <span class="c1">#                             crossings.append(new_crossings)</span>

    <span class="c1">#             if crossings:</span>
    <span class="c1">#                 all_crossings.append((i1, i2, np.vstack(crossings)))</span>

    <span class="c1">#     linkings = []</span>

    <span class="c1">#     return all_crossings</span>
                    
        
<span class="k">def</span><span class="w"> </span><span class="nf">_interpret_line</span><span class="p">(</span><span class="n">line</span><span class="p">):</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">line</span><span class="p">,</span> <span class="n">Knot</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">line</span><span class="o">.</span><span class="n">points</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">line</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">line</span>

    <span class="k">return</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Lines must be Knots or ndarrays.&#39;</span><span class="p">)</span>

<span class="k">def</span><span class="w"> </span><span class="nf">_test_periodicity</span><span class="p">(</span><span class="n">line</span><span class="p">,</span> <span class="n">shape</span><span class="p">):</span>
    <span class="n">closing_vector</span> <span class="o">=</span> <span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">line</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">shape</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">closing_vector</span> <span class="o">&gt;</span> <span class="mf">0.2</span><span class="p">):</span>
        <span class="k">return</span> <span class="s1">&#39;nth&#39;</span>
    <span class="k">return</span> <span class="s1">&#39;loop&#39;</span>

<span class="k">def</span><span class="w"> </span><span class="nf">_cut_line_at_jumps</span><span class="p">(</span><span class="n">line</span><span class="p">,</span> <span class="n">shape</span><span class="p">):</span>
    <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span> <span class="o">=</span> <span class="n">shape</span>
    <span class="n">shape</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">shape</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">x</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">y</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">z</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">line</span>
    <span class="n">line</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">out</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">while</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">line</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">):</span>
        <span class="n">cur</span> <span class="o">=</span> <span class="n">line</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="n">nex</span> <span class="o">=</span> <span class="n">line</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">nex</span><span class="o">-</span><span class="n">cur</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mf">0.9</span><span class="o">*</span><span class="n">shape</span><span class="p">):</span>
            <span class="n">first_half</span> <span class="o">=</span> <span class="n">line</span><span class="p">[:(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)]</span>
            <span class="n">second_half</span> <span class="o">=</span> <span class="n">line</span><span class="p">[(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">):]</span>
            <span class="n">out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">first_half</span><span class="p">)</span>
            <span class="n">line</span> <span class="o">=</span> <span class="n">second_half</span>
            <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="n">out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">out</span>

<span class="k">def</span><span class="w"> </span><span class="nf">_cram_into_cell</span><span class="p">(</span><span class="n">line</span><span class="p">,</span> <span class="n">shape</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;Imposes the shape as periodic boundary conditions.&#39;&#39;&#39;</span>
    <span class="n">shape</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">shape</span><span class="p">)</span>
    <span class="n">dx</span><span class="p">,</span> <span class="n">dy</span><span class="p">,</span> <span class="n">dz</span> <span class="o">=</span> <span class="n">shape</span>

    <span class="n">points</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">line</span><span class="p">)</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">points</span><span class="p">)):</span>
        <span class="n">prev</span> <span class="o">=</span> <span class="n">points</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">cur</span> <span class="o">=</span> <span class="n">points</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="n">rest</span> <span class="o">=</span> <span class="n">points</span><span class="p">[</span><span class="n">i</span><span class="p">:]</span>
        <span class="k">if</span> <span class="n">cur</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">rest</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">+=</span> <span class="n">dx</span>
        <span class="k">if</span> <span class="n">cur</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">dx</span><span class="p">:</span>
            <span class="n">rest</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">-=</span> <span class="n">dx</span>
        <span class="k">if</span> <span class="n">cur</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">rest</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">+=</span> <span class="n">dy</span>
        <span class="k">if</span> <span class="n">cur</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">dy</span><span class="p">:</span>
            <span class="n">rest</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">-=</span> <span class="n">dy</span>
        <span class="k">if</span> <span class="n">cur</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">rest</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">+=</span> <span class="n">dz</span>
        <span class="k">if</span> <span class="n">cur</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">dz</span><span class="p">:</span>
            <span class="n">rest</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">-=</span> <span class="n">dz</span>

    <span class="k">return</span> <span class="n">points</span>

<span class="k">def</span><span class="w"> </span><span class="nf">_is_closed_loop</span><span class="p">(</span><span class="n">line</span><span class="p">,</span> <span class="n">cutoff</span><span class="o">=</span><span class="mf">5.</span><span class="p">):</span>
    <span class="n">closing_distance</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">((</span><span class="n">line</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">line</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">closing_distance</span> <span class="o">&lt;</span> <span class="n">cutoff</span>


<span class="kn">from</span><span class="w"> </span><span class="nn">pyknotid.spacecurves.link</span><span class="w"> </span><span class="kn">import</span> <span class="n">Link</span>

<span class="k">class</span><span class="w"> </span><span class="nc">BoundingBox</span><span class="p">:</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">l</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">l</span><span class="p">,</span> <span class="s1">&#39;points&#39;</span><span class="p">):</span>
            <span class="c1"># crudely get the points if l is a</span>
            <span class="c1"># Knot or SpaceCurve</span>
            <span class="n">l</span> <span class="o">=</span> <span class="n">l</span><span class="o">.</span><span class="n">points</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">mins</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">l</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">maxs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">l</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">intersects</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
        <span class="n">b1</span> <span class="o">=</span> <span class="bp">self</span>
        <span class="n">b2</span> <span class="o">=</span> <span class="n">b</span>

        <span class="n">b1xmax</span><span class="p">,</span> <span class="n">b1ymax</span><span class="p">,</span> <span class="n">b1zmax</span> <span class="o">=</span> <span class="n">b1</span><span class="o">.</span><span class="n">maxs</span>
        <span class="n">b1xmin</span><span class="p">,</span> <span class="n">b1ymin</span><span class="p">,</span> <span class="n">b1zmin</span> <span class="o">=</span> <span class="n">b1</span><span class="o">.</span><span class="n">mins</span>

        <span class="n">b2xmax</span><span class="p">,</span> <span class="n">b2ymax</span><span class="p">,</span> <span class="n">b2zmax</span> <span class="o">=</span> <span class="n">b2</span><span class="o">.</span><span class="n">maxs</span>
        <span class="n">b2xmin</span><span class="p">,</span> <span class="n">b2ymin</span><span class="p">,</span> <span class="n">b2zmin</span> <span class="o">=</span> <span class="n">b2</span><span class="o">.</span><span class="n">mins</span>

        <span class="k">return</span> <span class="p">(</span><span class="n">b1xmax</span> <span class="o">&gt;</span> <span class="n">b2xmin</span> <span class="ow">and</span>
                <span class="n">b1xmin</span> <span class="o">&lt;</span> <span class="n">b2xmax</span> <span class="ow">and</span>
                <span class="n">b1ymax</span> <span class="o">&gt;</span> <span class="n">b2ymin</span> <span class="ow">and</span>
                <span class="n">b1ymin</span> <span class="o">&lt;</span> <span class="n">b2ymax</span> <span class="ow">and</span>
                <span class="n">b1zmax</span> <span class="o">&gt;</span> <span class="n">b2zmin</span> <span class="ow">and</span>
                <span class="n">b1zmin</span> <span class="o">&lt;</span> <span class="n">b2zmax</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">translations_to</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">shape</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Returns the translations of b1 that could make it overlap b2.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">b1</span> <span class="o">=</span> <span class="bp">self</span>
        <span class="n">b2</span> <span class="o">=</span> <span class="n">b</span>

        <span class="n">size1</span> <span class="o">=</span> <span class="n">b1</span><span class="o">.</span><span class="n">maxs</span> <span class="o">-</span> <span class="n">b1</span><span class="o">.</span><span class="n">mins</span>
        <span class="n">size2</span> <span class="o">=</span> <span class="n">b2</span><span class="o">.</span><span class="n">maxs</span> <span class="o">-</span> <span class="n">b2</span><span class="o">.</span><span class="n">mins</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">shape</span><span class="p">,</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">)):</span>
            <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">shape</span><span class="p">))</span> <span class="o">==</span> <span class="mi">1</span>
            <span class="n">shape</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

        <span class="c1"># should these have +1 and -1?</span>
        <span class="n">steps_mins</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">floor</span><span class="p">((</span><span class="n">b2</span><span class="o">.</span><span class="n">mins</span> <span class="o">-</span> <span class="n">b1</span><span class="o">.</span><span class="n">maxs</span><span class="p">)</span> <span class="o">/</span> <span class="n">shape</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="n">steps_maxs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">floor</span><span class="p">((</span><span class="n">b2</span><span class="o">.</span><span class="n">maxs</span> <span class="o">-</span> <span class="n">b1</span><span class="o">.</span><span class="n">mins</span><span class="p">)</span> <span class="o">/</span> <span class="n">shape</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">steps_mins</span><span class="p">,</span> <span class="n">steps_maxs</span>

        <span class="n">distance_from_b2_to_b1</span> <span class="o">=</span> <span class="n">b2</span><span class="o">.</span><span class="n">mins</span> <span class="o">-</span> <span class="n">b1</span><span class="o">.</span><span class="n">mins</span>
        <span class="n">num_steps_from_b2_to_b1</span> <span class="o">=</span> <span class="n">distance_from_b2_to_b1</span> <span class="o">/</span> <span class="n">shape</span>


<span class="k">def</span><span class="w"> </span><span class="nf">get_linking_between_loops</span><span class="p">(</span><span class="n">line1</span><span class="p">,</span> <span class="n">line2</span><span class="p">,</span> <span class="n">shape</span><span class="p">,</span>
                              <span class="n">same_loop</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                              <span class="n">periodic</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">periodic</span><span class="p">:</span>
        <span class="n">l</span> <span class="o">=</span> <span class="n">Link</span><span class="o">.</span><span class="n">from_periodic_lines</span><span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">(</span><span class="n">line1</span><span class="p">),</span>
                                      <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">(</span><span class="n">line2</span><span class="p">)),</span>
                                     <span class="n">shape</span><span class="p">,</span>
                                     <span class="n">perturb</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">l</span> <span class="o">=</span> <span class="n">Link</span><span class="p">((</span><span class="n">line1</span><span class="p">,</span> <span class="n">line2</span><span class="p">))</span>
    <span class="n">b1</span> <span class="o">=</span> <span class="n">BoundingBox</span><span class="p">(</span><span class="n">l</span><span class="o">.</span><span class="n">lines</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">points</span><span class="p">)</span>
    <span class="n">b2</span> <span class="o">=</span> <span class="n">BoundingBox</span><span class="p">(</span><span class="n">l</span><span class="o">.</span><span class="n">lines</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">points</span><span class="p">)</span>

    <span class="c1"># Get the range of x, y and z translations under</span>
    <span class="c1"># which the bounding boxes collide</span>

    <span class="n">translations</span> <span class="o">=</span> <span class="n">b2</span><span class="o">.</span><span class="n">translations_to</span><span class="p">(</span><span class="n">b1</span><span class="p">,</span> <span class="n">shape</span><span class="p">)</span>

    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;translations are&#39;</span><span class="p">,</span> <span class="n">translations</span><span class="p">)</span>

    <span class="n">linkings</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">for</span> <span class="n">dx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">translations</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">translations</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">dy</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">translations</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span> <span class="n">translations</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">dz</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">translations</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">2</span><span class="p">],</span> <span class="n">translations</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">same_loop</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">dx</span> <span class="o">==</span> <span class="n">dy</span> <span class="o">==</span> <span class="n">dz</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="k">continue</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;dx dy dz&#39;</span><span class="p">,</span> <span class="n">dx</span><span class="p">,</span> <span class="n">dy</span><span class="p">,</span> <span class="n">dz</span><span class="p">,</span> <span class="n">translations</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">translations</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
                <span class="n">points1</span> <span class="o">=</span> <span class="n">l</span><span class="o">.</span><span class="n">lines</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">points</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                <span class="n">points2</span> <span class="o">=</span> <span class="n">l</span><span class="o">.</span><span class="n">lines</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">points</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

                <span class="n">points2</span> <span class="o">+=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">dx</span><span class="p">,</span> <span class="n">dy</span><span class="p">,</span> <span class="n">dz</span><span class="p">])</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">shape</span><span class="p">)</span>

                <span class="n">b2</span> <span class="o">=</span> <span class="n">BoundingBox</span><span class="p">(</span><span class="n">points2</span><span class="p">)</span>

                <span class="k">if</span> <span class="ow">not</span> <span class="n">b1</span><span class="o">.</span><span class="n">intersects</span><span class="p">(</span><span class="n">b2</span><span class="p">):</span>
                    <span class="k">continue</span>

                <span class="n">l_new</span> <span class="o">=</span> <span class="n">Link</span><span class="p">((</span><span class="n">points1</span><span class="p">,</span> <span class="n">points2</span><span class="p">),</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                <span class="n">l_new</span><span class="o">.</span><span class="n">rotate</span><span class="p">()</span>

                <span class="n">linking_number</span> <span class="o">=</span> <span class="n">l_new</span><span class="o">.</span><span class="n">linking_number</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">linking_number</span><span class="p">:</span>
                    <span class="n">linkings</span><span class="p">[(</span><span class="n">dx</span><span class="p">,</span> <span class="n">dy</span><span class="p">,</span> <span class="n">dz</span><span class="p">)]</span> <span class="o">=</span> <span class="n">linking_number</span>

    <span class="k">return</span> <span class="n">linkings</span>

<span class="k">def</span><span class="w"> </span><span class="nf">get_linking_between_loop_and_line</span><span class="p">(</span><span class="n">loop</span><span class="p">,</span> <span class="n">line</span><span class="p">,</span> <span class="n">shape</span><span class="p">,</span>
                                      <span class="n">periodic</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>

    <span class="n">loop</span><span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">(</span><span class="n">loop</span><span class="p">)</span>
    <span class="n">line</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
    <span class="n">loop</span> <span class="o">=</span> <span class="n">Knot</span><span class="o">.</span><span class="n">from_periodic_line</span><span class="p">(</span><span class="n">loop</span><span class="p">,</span> <span class="n">shape</span><span class="p">)</span>
    <span class="n">line</span> <span class="o">=</span> <span class="n">OpenKnot</span><span class="o">.</span><span class="n">from_periodic_line</span><span class="p">(</span><span class="n">line</span><span class="p">,</span> <span class="n">shape</span><span class="p">)</span>

    <span class="n">line_closure</span> <span class="o">=</span> <span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">points</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">line</span><span class="o">.</span><span class="n">points</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">/</span> <span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">line_closure</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">line_closure</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>

    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;closure is&#39;</span><span class="p">,</span> <span class="n">line_closure</span><span class="p">)</span>

    <span class="n">b1</span> <span class="o">=</span> <span class="n">BoundingBox</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">points</span><span class="p">)</span>
    <span class="n">b2</span> <span class="o">=</span> <span class="n">BoundingBox</span><span class="p">(</span><span class="n">loop</span><span class="o">.</span><span class="n">points</span><span class="p">)</span>

    <span class="c1"># Get the range of x, y and z translations under</span>
    <span class="c1"># which the bounding boxes collide</span>

    <span class="n">translations</span> <span class="o">=</span> <span class="n">b2</span><span class="o">.</span><span class="n">translations_to</span><span class="p">(</span><span class="n">b1</span><span class="p">,</span> <span class="n">shape</span><span class="p">)</span>

    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;translations are&#39;</span><span class="p">,</span> <span class="n">translations</span><span class="p">)</span>

    <span class="n">linkings</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="kn">from</span><span class="w"> </span><span class="nn">pyknotid.spacecurves.link</span><span class="w"> </span><span class="kn">import</span> <span class="n">Link</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">pyknotid.spacecurves.rotation</span><span class="w"> </span><span class="kn">import</span> <span class="n">rotate_vector_to_top</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">pyknotid.utils</span><span class="w"> </span><span class="kn">import</span> <span class="n">get_rotation_matrix</span>

    <span class="n">random_matrix</span> <span class="o">=</span> <span class="n">get_rotation_matrix</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span>

    <span class="c1"># loop._apply_matrix(rotation_matrix)</span>
    <span class="c1"># line._apply_matrix(rotation_matrix)</span>

    <span class="n">loop</span><span class="o">.</span><span class="n">_apply_matrix</span><span class="p">(</span><span class="n">random_matrix</span><span class="p">)</span>
    <span class="n">line</span><span class="o">.</span><span class="n">_apply_matrix</span><span class="p">(</span><span class="n">random_matrix</span><span class="p">)</span>

    <span class="n">to_top_matrix</span> <span class="o">=</span> <span class="n">rotate_vector_to_top</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">points</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">line</span><span class="o">.</span><span class="n">points</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

    <span class="n">loop</span><span class="o">.</span><span class="n">_apply_matrix</span><span class="p">(</span><span class="n">to_top_matrix</span><span class="p">)</span>
    <span class="n">line</span><span class="o">.</span><span class="n">_apply_matrix</span><span class="p">(</span><span class="n">to_top_matrix</span><span class="p">)</span>

    <span class="c1"># Switch x and z axes</span>
    <span class="c1"># loop.points[:, 0], loop.points[:, 2] = loop.points[:, 2], loop.points[:, 0]</span>
    <span class="c1"># line.points[:, 0], line.points[:, 2] = line.points[:, 2], line.points[:, 0]</span>

    <span class="n">axis_rotation</span> <span class="o">=</span> <span class="n">get_rotation_matrix</span><span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mf">2.</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>

    <span class="n">line</span><span class="o">.</span><span class="n">_apply_matrix</span><span class="p">(</span><span class="n">axis_rotation</span><span class="p">)</span>
    <span class="n">loop</span><span class="o">.</span><span class="n">_apply_matrix</span><span class="p">(</span><span class="n">axis_rotation</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">dx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">translations</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">translations</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">dy</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">translations</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span> <span class="n">translations</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">dz</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">translations</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">2</span><span class="p">],</span> <span class="n">translations</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>

                <span class="nb">print</span><span class="p">(</span><span class="n">dx</span><span class="p">,</span> <span class="n">dy</span><span class="p">,</span> <span class="n">dz</span><span class="p">)</span>

                <span class="n">translation</span> <span class="o">=</span> <span class="n">random_matrix</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">((</span><span class="n">dx</span><span class="p">,</span> <span class="n">dy</span><span class="p">,</span> <span class="n">dz</span><span class="p">))</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">shape</span><span class="p">))</span>
                <span class="n">translation</span> <span class="o">=</span> <span class="n">to_top_matrix</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">translation</span><span class="p">)</span>
                <span class="n">translation</span> <span class="o">=</span> <span class="n">axis_rotation</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">translation</span><span class="p">)</span>

                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;translation is&#39;</span><span class="p">,</span> <span class="n">translation</span><span class="p">)</span>

                <span class="n">points1</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">points</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                <span class="n">points2</span> <span class="o">=</span> <span class="n">loop</span><span class="o">.</span><span class="n">points</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                <span class="n">points1</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">points1</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

                <span class="n">points2</span> <span class="o">+=</span> <span class="n">translation</span>

                <span class="n">b1</span> <span class="o">=</span> <span class="n">BoundingBox</span><span class="p">(</span><span class="n">points1</span><span class="p">)</span>
                <span class="n">b2</span> <span class="o">=</span> <span class="n">BoundingBox</span><span class="p">(</span><span class="n">points2</span><span class="p">)</span>


                <span class="k">if</span> <span class="ow">not</span> <span class="n">b1</span><span class="o">.</span><span class="n">intersects</span><span class="p">(</span><span class="n">b2</span><span class="p">):</span>
                    <span class="k">continue</span>

                <span class="n">l</span> <span class="o">=</span> <span class="n">Link</span><span class="p">((</span><span class="n">points1</span><span class="p">,</span> <span class="n">points2</span><span class="p">),</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

                <span class="n">linking_number</span> <span class="o">=</span> <span class="n">l</span><span class="o">.</span><span class="n">linking_number</span><span class="p">(</span><span class="n">include_closures</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

                <span class="c1"># if linking_number:</span>
                <span class="c1">#     import ipdb</span>
                <span class="c1">#     ipdb.set_trace()</span>


                <span class="k">if</span> <span class="n">linking_number</span><span class="p">:</span>
                    <span class="n">linkings</span><span class="p">[(</span><span class="n">dx</span><span class="p">,</span> <span class="n">dy</span><span class="p">,</span> <span class="n">dz</span><span class="p">)]</span> <span class="o">=</span> <span class="n">linking_number</span>
                
    <span class="k">return</span> <span class="n">linkings</span>
                

                <span class="c1"># We can calculate the linking number as a link in the current plane, as the crossings will be made up later</span>

    <span class="c1"># 0.1) Choose a random rotation</span>

    <span class="c1"># 1) Rotate the line to have homology vector in z=0</span>
    <span class="c1"># 2) For every translation where the loop overlaps the line at all...</span>
    <span class="c1">#    ...but factoring out translations that are multiples of the line&#39;s homology vector!</span>
    <span class="c1"># 3) Extend the line as far as necessary</span>
    <span class="c1"># 4) Calculate the linking</span>

    <span class="c1"># For every position where the </span>


<span class="n">loop1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mf">0.</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
                  <span class="p">[</span><span class="mi">5</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
                  <span class="p">[</span><span class="mi">5</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
                  <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
                  <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]])</span>

<span class="n">loop2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mf">2.5</span><span class="p">,</span> <span class="mf">2.5</span><span class="p">,</span> <span class="o">-</span><span class="mi">3</span><span class="p">],</span>
                  <span class="p">[</span><span class="mf">2.5</span><span class="p">,</span> <span class="mf">2.5</span><span class="p">,</span> <span class="mi">3</span><span class="p">],</span>
                  <span class="p">[</span><span class="mi">7</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">3</span><span class="p">],</span>
                  <span class="p">[</span><span class="mi">7</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="o">-</span><span class="mi">3</span><span class="p">],</span>
                  <span class="p">[</span><span class="mf">2.7</span><span class="p">,</span> <span class="mf">2.65</span><span class="p">,</span> <span class="o">-</span><span class="mi">3</span><span class="p">]])</span>

<span class="n">loop3</span> <span class="o">=</span> <span class="n">loop2</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">30.</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span>
</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2014-2018.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>